import 'package:flutter/material.dart';
import 'package:slimtrap/components/ui/appbar.dart';
import '../components/ui/card.dart';

class BodyFormCustomer extends StatefulWidget {
  final String id,
      name,
      phone,
      age,
      weight,
      height,
      medicalHistory,
      city,
      email,
      timeStamp;
  final bool isMale;
  const BodyFormCustomer({
    Key? key,
    required this.id,
    required this.name,
    required this.phone,
    required this.age,
    required this.weight,
    required this.height,
    required this.medicalHistory,
    required this.email,
    required this.isMale,
    required this.timeStamp,
    required this.city,
  }) : super(key: key);

  @override
  State<BodyFormCustomer> createState() => _BodyFormCustomerState();
}

class _BodyFormCustomerState extends State<BodyFormCustomer> {
  final GlobalKey<FormState> formKey = GlobalKey<FormState>();
  bool isEditing = false;
  List errorMessage = [];

  String? _validateField(String? value, String label) {
    if (label == 'Name') {
      if (value!.length < 3 ||
          !value.contains(RegExp(r'^((\b[a-zA-Z]{2,40}\b)\s*){2,3}$'))) {
        errorMessage.add('Please enter a valid name');
        return '';
      }
    } else if (label.contains('Email')) {
      // email field can be empty or should be valid email format
      if (value!.isNotEmpty &&
          (!RegExp(r'^.+@[a-zA-Z]+\.{1}[a-zA-Z]+(\.{0,1}[a-zA-Z]+)$')
              .hasMatch(value))) {
        errorMessage.add('Please enter a valid email address');
        return '';
      }
    } else if (label.contains('Phone')) {
      // check if phone is valid indian number
      if (!RegExp(r'^[6-9]\d{9}$').hasMatch(value!)) {
        errorMessage.add('Please enter a valid Indian phone number');
        return '';
      }
    } else if (label == 'Medical History (optional)') {
      // medical history field can be empty
    } else if (label == 'Gender') {
      if (value?.toLowerCase() != 'm' && value?.toLowerCase() != 'f') {
        errorMessage.add('Please enter M or F in $label');
        return '';
      }
    } else if (value!.isNotEmpty && label == 'Age') {
      // if age is valid int and between 18 and 100 then return null
      if (int.tryParse(value) == null) {
        errorMessage.add('Please enter a valid age');
        return '';
      } else if (int.parse(value) < 15 || int.parse(value) > 100) {
        errorMessage.add('Please enter a valid age');
        return '';
      }
    } else if (value.isNotEmpty && label == 'Weight (kg)') {
      // if weight is valid int and between 18 and 100 then return null
      if (double.tryParse(value) == null) {
        errorMessage.add('Please enter a valid weight');
        return '';
      } else if (double.parse(value) < 30 || double.parse(value) > 200) {
        errorMessage.add('Please enter a valid weight');
        return '';
      }
    } else if (value.isNotEmpty && label == 'Height (cm)') {
      // if height is valid int and between 18 and 100 then return null
      if (int.tryParse(value) == null) {
        errorMessage.add('Please enter a valid height');
        return '';
      } else if (int.parse(value) < 50 || int.parse(value) > 250) {
        errorMessage.add('Please enter a valid height');
        return '';
      }
    } else {
      if (value.isEmpty) {
        errorMessage.add('Please enter a value for $label');
        return 'Please enter a value for $label';
      }
    }
    return null;
  }

  @override
  Widget build(BuildContext context) {
    List<Map<String, dynamic>> fields = [
      {
        "label": "Name",
        "controller": TextEditingController(text: widget.name),
        "icon": Icons.person,
      },
      {
        "label": "Phone (+91)",
        "controller": TextEditingController(text: widget.phone.substring(3)),
        "icon": Icons.phone,
      },
      {
        "label": "City",
        "controller": TextEditingController(text: widget.city),
        "icon": Icons.location_city,
      },
      {
        "label": "Email",
        "controller": TextEditingController(text: widget.email),
        "icon": Icons.email,
      },
      {
        "label": "Gender",
        "controller": TextEditingController(text: widget.isMale ? 'M' : 'F'),
        "icon": Icons.person,
      },
      {
        "label": "Age",
        "controller": TextEditingController(text: widget.age),
        "icon": Icons.cake,
      },
      {
        "label": "Weight (kg)",
        "controller": TextEditingController(text: widget.weight),
        "icon": Icons.line_weight,
      },
      {
        "label": "Height (cm)",
        "controller": TextEditingController(text: widget.height),
        "icon": Icons.height,
      },
    ];
    return GestureDetector(
      onTap: () {
        FocusScope.of(context).unfocus();
      },
      child: Scaffold(
        appBar: MyAppBar(
          title: widget.name,
          leftIcon: IconButton(
            icon: const Icon(Icons.arrow_back_rounded),
            color: Colors.black26,
            onPressed: () => Navigator.pop(context),
          ),
        ),
        body: Container(
          margin: const EdgeInsets.symmetric(vertical: 15, horizontal: 10),
          child: Form(
            key: formKey,
            child: ListView(
              physics: const BouncingScrollPhysics(),
              children: [
                for (int i = 0; i < fields.length; i++)
                  buildCard(
                      icon: fields[i]['icon'],
                      label: fields[i]['label'],
                      controller: fields[i]['controller']),
              ],
            ),
          ),
        ),
        floatingActionButton: FloatingActionButton(
          onPressed: () {
            if (formKey.currentState!.validate()) {
              try {
                // print all the values in the form
                formKey.currentState!.save();
                // for (int i = 0; i < formKey.currentState!.fields.length; i++) {
                //   print(formKey.currentState!.fields[i].value);
                // }
              } catch (e) {
                ScaffoldMessenger.of(context).showSnackBar(
                  SnackBar(
                    content: Text('Error updating customer $e'),
                    backgroundColor: Colors.red,
                  ),
                );
              }
              // if susuccessful show successful message
            } else {
              // break line for each error message if there are multiple
              String error = '';
              for (int i = 0; i < errorMessage.length; i++) {
                error += errorMessage[i];
                if (i != errorMessage.length - 1) {
                  error += '\n';
                }
              }

              // show error message
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(
                  content: Text(error),
                  backgroundColor: Colors.red,
                ),
              );
              errorMessage = [];
            }
          },
          child: const Icon(Icons.save),
        ),
      ),
    );
  }

  Widget buildCard(
      {required String label,
      required IconData icon,
      TextEditingController? controller}) {
    final textPainter = TextPainter(
      text: TextSpan(
          text: controller?.text.trim(), style: const TextStyle(fontSize: 16)),
      textDirection: TextDirection.ltr,
    )..layout();

    final fieldWidth = textPainter.size.width + 5;

    return Container(
      margin: const EdgeInsets.only(bottom: 5),
      child: Column(
        children: [
          UICard(
            children: [
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Row(
                    children: [
                      Icon(icon),
                      const SizedBox(width: 10),
                      Text(label),
                    ],
                  ),
                  if (label != 'Created' && label != 'Medical History')
                    SizedBox(
                      width: label == 'Email' && controller!.text.isEmpty
                          ? fieldWidth
                          : 150,
                      child: TextFormField(
                        // initialValue: value,
                        keyboardType: label.toString().contains('Email')
                            ? TextInputType.emailAddress
                            : label == 'Name' ||
                                    label == 'City' ||
                                    label == 'Gender'
                                ? TextInputType.text
                                : TextInputType.number,
                        decoration: const InputDecoration(
                          border: InputBorder.none,
                          contentPadding: EdgeInsets.all(0),
                          errorStyle: TextStyle(
                              height: 0,
                              fontSize: 0,
                              color: Colors.transparent),
                          focusedErrorBorder: InputBorder.none,
                          errorBorder: InputBorder.none,
                        ),
                        onChanged: (newValue) {
                          setState(() {
                            isEditing = true;
                          });
                        },
                        validator: (value) => _validateField(value, label),
                        controller: controller,
                      ),
                    )
                  else
                    Text(controller!.text),
                ],
              )
            ],
          ),
          // error should be shown here
          // Text()
        ],
      ),
    );
  }
}


//  Container(
//                     margin: const EdgeInsets.symmetric(vertical: 5),
//                     child: TextFormField(
//                       controller: fields[i]['controller'],
//                       decoration: InputDecoration(
//                         labelText: fields[i]['label'],
//                         prefixIcon: Icon(fields[i]['icon']),
//                         border: OutlineInputBorder(
//                           borderRadius: BorderRadius.circular(10),
//                         ),
//                         errorStyle: const TextStyle(
//                           color: Colors.red,
//                           fontSize: 15,
//                         ),
//                       ),
//                       validator: (value) =>
//                           _validateField(value, fields[i]['label']),
//                       onSaved: (value) {
//                         fields[i]['value'] = value;
//                       },
//                     ),
//                   ),